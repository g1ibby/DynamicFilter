<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_default
 * @copyright   Copyright (c) 2014 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php
/**
 * @see Mage_Adminhtml_Block_Catalog_Product
 */
?>
<div class="content-header">
<table cellspacing="0">
    <tr>
        <td style="width:50%;"><h3 class="icon-head head-products"><?php echo Mage::helper('catalog')->__('Manage Products') ?></h3></td>
        <td class="a-right">
            <?php echo $this->getButtonsHtml() ?>
        </td>
    </tr>
</table>
</div>
<?php if( !$this->isSingleStoreMode() ): ?>
<?php echo $this->getChildHtml('store_switcher');?>
<?php endif;?>
<div>
    <?php echo $this->getGridHtml() ?>
</div>
<script>
    jQuery( document ).ready(function( $ ) {
        var pastValue = '';

        var ac = $('.attrsearch').autocomplete({
            serviceUrl: '<?php echo Mage::getUrl() . 'admin/df/search/key/' .  Mage::getSingleton('adminhtml/url')->getSecretKey(); ?>/?isAjax=1',
            minChars: 2,
            maxHeight: 400,
            width: 300,
            zIndex: 9999,
            deferRequestBy: 0,
            params: {form_key: '<?php echo Mage::getSingleton('core/session')->getFormKey() ?>'},
            paramName: 'dynamic_filter',
            type: 'POST',
            onSelect: function(value, data) {
                var formURL = '<?php echo Mage::getUrl() . 'admin/df/filter/key/' .  Mage::getSingleton('adminhtml/url')->getSecretKey(); ?>/?isAjax=1';
                $.ajax(
                    {
                        url : formURL,
                        type: "POST",
                        data : 'dynamic_filter=' + value.value + '&form_key=' + '<?php echo Mage::getSingleton('core/session')->getFormKey() ?>&previous_value=' + value.previous_value,
                        success:function(data, textStatus, jqXHR)
                        {
                            productGridJsObject.doFilter()
                        }
                    });
            }
        });

        $('body .edit-filter').on('click', function(e) {
            console.log('edit');
            var parent = $(this).parent('span');
            var filter = $($(parent).children('a')[0]).attr('name');
            console.log(filter);
            $(parent).html('<input name="dynamic_filter" class="attrsearch" placeholder="Dynamic filter" previous_value="' + filter + '"/>');
        });

        $('body .delete-filter').on('click', function(e) {
            console.log('delete');
            var parent = $(this).parent('span');
            var filter = $($(parent).children('a')[0]).attr('name');
            var formURL = '<?php echo Mage::getUrl() . 'admin/df/delete/key/' .  Mage::getSingleton('adminhtml/url')->getSecretKey(); ?>/?isAjax=1';
            $.ajax(
                {
                    url :    formURL,
                    type:    "POST",
                    data :   'dynamic_filter=' + filter + '&form_key=' + '<?php echo Mage::getSingleton('core/session')->getFormKey() ?>',
                    success: function(data, textStatus, jqXHR)
                    {
                        productGridJsObject.doFilter()
                    }
                });
        });
    });
</script>